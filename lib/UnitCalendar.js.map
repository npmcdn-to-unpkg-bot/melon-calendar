{"version":3,"sources":["UnitCalendar.js"],"names":["normalize","getNextTime","getContinuousFragments","date","cx","UnitCalendar","props","onChange","bind","parse","format","e","nextValue","value","state","target","continuous","calculate","map","current","next","sort","cLength","length","nLength","unit","firtNext","Date","firstCurrent","concat","lastNext","setDate","getDate","lastCurrent","slice","i","time","parseValue","split","stringifyValue","term","join","render","begin","end","rest","fragment","options","build","propTypes","instanceOf","oneOf","isRequired","arrayOf","bool","defaultValue","string","defaultProps","getDay","setMonth","getMonth","setFullYear","getFullYear","result","push"],"mappings":"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","file":"UnitCalendar.js","sourcesContent":["/**\n * @file UnitCalendar\n * @author leon(ludafa@outlook.com)\n */\n\nimport React, {PropTypes} from 'react';\n\nimport {create} from 'melon-core/classname/cxBuilder';\nimport InputComponent from 'melon-core/InputComponent';\n\nimport BoxGroup from 'melon/BoxGroup';\nimport * as date from './util';\n\nconst cx = create('UnitCalendar');\n\nexport default class UnitCalendar extends InputComponent {\n\n    constructor(props) {\n        super(props);\n        this.onChange = this.onChange.bind(this);\n        this.parse = this.parse.bind(this);\n        this.format = this.format.bind(this);\n    }\n\n    onChange(e) {\n\n        const nextValue = e.value;\n\n        const value = this.state.value;\n\n        super.onChange({\n\n            target: this,\n\n            // 如果是连续的，这里需要算一下，不是连续的就以新值为主\n            value: this.props.continuous\n                ? this.calculate(value, nextValue).map(this.parse)\n                : value\n        });\n\n    }\n\n    calculate(current, next) {\n\n        current = current.map(this.format).sort();\n\n        next = next.sort();\n\n        let cLength = current.length;\n        let nLength = next.length;\n        let unit = this.props.unit;\n\n        if (cLength === nLength) {\n            return current;\n        }\n\n        if (!cLength || !nLength) {\n            return next;\n        }\n\n        // fill\n        if (cLength < nLength) {\n\n            let firtNext = new Date(next[0]);\n            let firstCurrent = new Date(current[0]);\n\n            if (firtNext < firstCurrent) {\n                return getContinuousFragments(firtNext, firstCurrent, unit).map(this.format).concat(current);\n            }\n\n            let lastNext = new Date(next[nLength - 1]);\n            lastNext.setDate(lastNext.getDate() + 1);\n            let lastCurrent = new Date(current[cLength - 1]);\n\n            return current.concat(getContinuousFragments(lastCurrent, lastNext, unit).slice(1).map(this.format));\n\n        }\n\n        // cut\n        for (let i = 0; i < nLength; ++i) {\n            if (current[i] < next[i]) {\n                if (i === 0) {\n                    return current.slice(1);\n                }\n                return current.slice(0, i);\n            }\n        }\n\n        return current.slice(0, -1);\n\n    }\n\n    parse(time) {\n        return date.parse(time, this.props.format);\n    }\n\n    format(time) {\n        return date.format(time, this.props.format);\n    }\n\n    parseValue(value = '') {\n        return value\n            .split(',')\n            .map(function (date) {\n                return this.parse(date);\n            });\n    }\n\n    stringifyValue(value = []) {\n        return value\n            .map(function (term) {\n                return this.format(term);\n            })\n            .join(',');\n    }\n\n    render() {\n\n        let {begin, end, unit, format, ...rest} = this.props;\n\n        let value = this.state.value;\n\n        value = value\n            .map(function (fragment) {\n                return date.format(normalize(fragment, unit), format);\n            })\n            .sort();\n\n        const options = getContinuousFragments(begin, end, unit).map(fragment => {\n            let begin = this.format(fragment);\n            let end = getNextTime(fragment, unit);\n            end.setDate(end.getDate() - 1);\n            end = this.format(end);\n            return (<option key={begin} value={begin} label={`${begin} ~ ${end}`} />);\n        });\n\n        return (\n            <div className={cx(this.props).build()}>\n                <BoxGroup\n                    {...rest}\n                    boxModel=\"checkbox\"\n                    onChange={this.onChange}\n                    value={value}>\n                    {options}\n                </BoxGroup>\n            </div>\n        );\n\n    }\n\n\n}\n\nUnitCalendar.propTypes = {\n    ...InputComponent.propTypes,\n    begin: PropTypes.instanceOf(Date),\n    end: PropTypes.instanceOf(Date),\n    unit: PropTypes.oneOf(['week', 'month', 'year']).isRequired,\n    value: PropTypes.arrayOf(Date),\n    continuous: PropTypes.bool.isRequired,\n    defaultValue: PropTypes.arrayOf(PropTypes.string)\n};\n\nUnitCalendar.defaultProps = {\n    ...InputComponent.defaultProps,\n    continuous: true,\n    defaultValue: [],\n    format: 'YYYY-MM-DD'\n};\n\nexport function normalize(time, unit) {\n    time = new Date(time);\n    // 得到周一\n    if (unit === 'week') {\n        time.setDate(time.getDate() - time.getDay() + 1);\n    }\n    // 得到1日\n    else if (unit === 'month') {\n        time.setDate(1);\n    }\n    // 得到1月1日\n    else {\n        time.setMonth(0);\n        time.setDate(1);\n    }\n    return time;\n}\n\nexport function getNextTime(time, unit) {\n    time = normalize(time, unit);\n    if (unit === 'week') {\n        time.setDate(time.getDate() + 7);\n    }\n    else if (unit === 'month') {\n        time.setMonth(time.getMonth() + 1);\n    }\n    else {\n        time.setFullYear(time.getFullYear() + 1);\n    }\n    return time;\n}\n\nexport function getContinuousFragments(begin, end, unit) {\n\n    begin = normalize(begin, unit);\n\n    let result = [];\n\n    while (begin < end) {\n        result.push(new Date(begin));\n        if (unit === 'week') {\n            begin.setDate(begin.getDate() + 7);\n        }\n        else if (unit === 'month') {\n            begin.setMonth(begin.getMonth() + 1);\n        }\n        else {\n            begin.setFullYear(begin.getFullYear() + 1);\n        }\n    }\n\n    return result;\n\n}\n"],"sourceRoot":"/source/"}